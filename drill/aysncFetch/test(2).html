<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body></body>
  <script src="./curry.js"></script>
  <script>
    //test1
    /*
    function getData(data) {
      return new Promise(function (resolve, reject) {
        console.log('请求开始');
        setTimeout(() => {
            data = data || 'request error';
            resolve(data);
        }, 4000*Math.random()+1);
      });
    }
    getData(1)
    .then(data=> {
        if (data !== 'request error') {
            console.log(data);
            return getData(2)
        }
    })
    .then(data=> {
        if (data !== 'request error') {
            console.log(data);
            return getData(3)
        }
    })
    .then(data=> {
        console.log(data);
    })
    //*/
    function getDataRandom() {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve();
        }, 2000 * Math.random() + 1000);
      });
    }
    function promiseConcurrency({ fetchFn, queryList, limit }) {
      return new Promise((resolve, reject) => {
        let sum = 0;
        let doing = 0;
        for (let i = 0; i < limit; i++) {
          work();
        }
        function work() {
            if (queryList.total > sum && limit > doing) {
                doing++;
                let current =  ++sum;
                if (sum > limit) { console.log('进程空闲即将开始处理...');}
                console.log(`${current}start`);
                fetchFn().finally(()=> {
                    doing--;
                    console.log(`${current}done`);
                    work();
                    if (queryList.total === sum && doing === 0) {
                        resolve()
                    }
                })
                if (limit === doing) { console.log('进程数以达到上限');}
            }
        }
      });
    }
    promiseConcurrency({ fetchFn: getDataRandom, queryList: { sum: 0, total: 2 }, limit: 3 }).then(() => {
      console.log('all task done');
    });

    const fn = (id) => new Promise((r) => {r()});
    const limit = 10;
    const id = [1,2,3,4,5];

    /**
     * 1: 传入进程数
     * 2: 判断是否达到上限
     * 3: 递归
     */
    
    
    //test2
    /*
    class taskManage {  
        sum = 0;
        max = 10;
        total = 0;
        doing = 0;
        allDone = false;
        constructor(total, max = 10) {
            this.total = total;
            this.max = max;
            this.start()
            return new Promise( (resolve, reject) => {
                Object.defineProperty(this,'allDone',{
                    set(val) {
                        if (val) {
                            resolve()
                        }
                    }
                })

            })
        }

        task() {
            return new Promise( (resolve, reject)=> {
                let {sum} = this;
                let time;
                if(sum === 10){
                    time = 5000
                }else {
                    time =4000 * Math.random() + 100
                }
                console.log(`task ${sum}start`);
                setTimeout(() => {
                    console.log(`task ${sum}done`);
                    resolve();
                }, time);
            });
        }

        work() {
            if (this.total > this.sum && this.max > this.doing) {
                this.doing++;
                this.sum++;
                if (this.sum > this.max) { console.log('进程空闲即将开始处理...');}
                this.task().then(()=> {
                    this.doing--;
                    this.work();
                    if (this.total === this.sum && this.doing === 0) {
                        this.allDone = true;
                    }
                })
                if (this.max === this.doing) { console.log('进程数以达到上线');}
            }
        }

        start() {
            for (let i = 0; i < this.max; i++) {
                this.work();
            }
        }
    }
   new taskManage(100,10).then(()=>{
        console.log('all task done');
    });
    //*/

    //test3
    /*
    function curry(fn, ...arg) {
      return (...rest) => {
        let newArg = [...arg, ...rest];
        if (rest.length === 0) return fn.apply(null, newArg);
        return curry(fn, ...newArg);
      };
    }
    function sum(...rest) {
      return rest.reduce((a, b) => a + b, 0);
    }
    let add = curry(sum);
    add(1)(2)(3,4)()
    //*/
  </script>
</html>
